---
title: "Pubmed"
author: "Trang Tran"
date: "8/21/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(rentrez)
library(GEOmetadb)
library(RSQLite)
library(magrittr)

count_year <- function(year, term) {
    query <- paste(term, "AND (", year, "[PDAT])")
    return(entrez_search(db="pubmed", term=query, retmax =0)$count)
}
sector.colors = c('cardiovascular diseases' = 'firebrick', 'cancer' = 'firebrick', 'bioinformatics' = 'gold4', 'cardioinformatics' = 'green', 'cancer.bioinf' = 'deepskyblue2' )
plot_pubcount <- function(data, yearsToPlot, varsToPlot) {
    p <- data %>%
        reshape2::melt(id.vars='year') %>%
        subset(variable %in% varsToPlot & year %in% yearsToPlot) %>%
        ggplot() +
            geom_bar(aes(x=year,y=value,group=variable, fill=variable), stat='identity', alpha=0.5, position='identity') +
            ylab('Number of publications on Pubmed') +
            scale_x_continuous(breaks = yearsToPlot, labels=as.character(yearsToPlot)) +
            scale_fill_manual(values=sector.colors) +
            theme(axis.text.x = element_text(hjust=1, angle=45)) +
            guides(fill=guide_legend(title=""))
    if (2018 %in% yearsToPlot)
        p <- p + annotate("text", x=2018, y=max(subset(data, year == 2018, varsToPlot))*1.1, label="*", size=7)
    return(p)    
}

```

```{r readData}
heartConditions = read.table('../data/conditionList.tsv', sep='\t', header = TRUE)
heartPubmed = list()


```

## Pubmed

### Publication on Cardiovascular diseases over the years

```{r}
relativePubmed <- data.frame('year' = c(1990:2018)) %>%
    `$<-`('CVD', sapply(.[['year']], function(x) { return(count_year(x, '"cardiovascular diseases"[MeSH Major Topic]'))})) %>%
    `$<-`('all', sapply(.[['year']], function(x) { return(count_year(x, ''))})) %>%
    `$<-`('bioinformatics', sapply(.[['year']], function(x) {return(count_year(x, 'bioinformatics[Other Term] OR genomics[MeSH Terms]'))})) %>%
    `$<-`('cardioinformatics',  sapply(.[['year']], function(x) {return(count_year(x, '(bioinformatics[Other Term] OR genomics[MeSH Terms]) AND ("cardiovascular diseases"[MeSH Major Topic])'))}))
```

#### Cardiovascular disease vs bioinformatics/genomics research since 2000 (when bioinformatics research starts to gather enough publication to be visible)

```{r}
yearsToPlot = 2000:2018
plot_pubcount(relativePubmed, yearsToPlot, varsToPlot = c('bioinformatics', 'cardioinformatics', 'cardiovascular diseases') ) 
```

#### The laggging of cardiovascular research in adopting bioinformatics/genomics technique

```{r}
plot_pubcount(relativePubmed, yearsToPlot = yearsToPlot, varsToPlot = c('bioinformatics', 'cardioinformatics') )
# relativePubmed %>%
#     reshape2::melt(id.vars='year') %>%
#     subset(variable %in% c('bioinformatics', 'cardio.bioinf') & year >= 2000) %>%
#     ggplot() +
#         geom_bar(aes(x=year,y=value,group=variable, fill=variable), stat='identity', alpha=0.5, position='identity') +
#         ylab('Number of publications on Pubmed') +
#         scale_x_discrete(labels=2000:2008)
        # geom_area(aes(x=year,y=value,group=variable, fill=variable), stat='identity', alpha=0.5) 

```

#### Just curious, how is it with cancer research?

```{r}
relativePubmed <- relativePubmed %>%
    `$<-`('cancer.bioinf',  sapply(.[['year']], function(x) {return(count_year(x, '(bioinformatics[Other Term] OR genomics[MeSH Terms]) AND (*cancer[MeSH Terms])'))})) %>%
    `$<-`('cancer',  sapply(.[['year']], function(x) {return(count_year(x, '(*cancer[MeSH Terms])'))}))

```

```{r}
plot_pubcount(relativePubmed, yearsToPlot = yearsToPlot, varsToPlot = c('cancer', 'bioinformatics', 'cancer.bioinf') ) +
    guides(fill=guide_legend(title=""))
```

```{r}
plot_pubcount(relativePubmed, yearsToPlot = yearsToPlot, varsToPlot = c('bioinformatics', 'cancer.bioinf', 'cardioinformatics') ) +
    guides(fill=guide_legend(title=""))
```

### Standard terms

```{r}
heartConditions$PubmedCount = 0
heartConditions$PubmedCount.MeSH = 0
for (i in 1:nrow(heartConditions)) {
    # tmp <- entrez_search(db='pubmed', term=paste0("(", heartConditions[i,'HPOTermName'], ")[MeSH]"))
    # heartConditions[i, 'PubmedCount.MeSH'] <- tmp$count
    heartPubmed[[i]] <- entrez_search(db='pubmed', term=paste0('("', heartConditions[i,'HPOTermName'], '")'))
}
```

```{r}
heartPubmed.Year <- list()
for (i in 1:nrow(heartConditions)) {
    cnts = sapply(c(1990:2017), function(y) { return(count_year(y, heartConditions[i, 'HPOTermName']))})
    heartPubmed.Year[[i]] = data.frame(year=c(1990:2017),
                                       count=cnts)
}
```

```{r}
for (i in 1:length(heartPubmed.Year)) {
    heartPubmed.Year[[i]]$HPOTermName = heartConditions[i,'HPOTermName']
}
p <- Reduce(rbind,heartPubmed.Year) %>%
    ggplot() +
    geom_line(aes(x=year, y=count, group=HPOTermName,color=HPOTermName))
ggplotly(p)
    
```

```{r}
ggplot(heartConditions) +
    geom_bar(aes(x=HPOTermName,y=PubmedCount), stat='identity', alpha=0.5) +
    geom_bar(aes(x=HPOTermName,y=PubmedCount.MeSH), stat='identity', alpha=0.5, color=2) +
    theme(axis.text.x = element_text(angle=30,hjust=1)) +
    scale_y_log10()
```

```{r}
lapply(heartPubmed, function(x) { return(x$count)})
```
```{r}
p <- ggplot(heartConditions) +
    geom_point(aes(x=PubmedCount, y=PubmedCount.MeSH)) 
ggplotly(p)
```

### Common names

```{r}
heartRegularPubmed <- 
    heartConditions$query %>%
    unique() %>%
    lapply( function(x) {
        return(entrez_search(db='pubmed', term=paste0('("', x, '")')))  
    })
```

```{r}
heartConditions$query %>%
    unique() %>%
    data.frame() %>%
    `$<-`('PubmedCount', sapply(heartRegularPubmed, function(x) {return(x$count)})) %>%
    `names<-`(c('Query', 'PubmedCount')) %>%
    ggplot() +
        geom_bar(aes(x=Query,y=PubmedCount), stat='identity') +
        theme(axis.text.x = element_text(angle=45,hjust=1))
```

## GEO

### Datasets deposited by the publications above

```{r}
cardioPubmed <-
    entrez_search(db='pubmed', term='"cardiovascular diseases"[MeSH Terms]', retmax=0)$count %>%
    entrez_search(db='pubmed', term='"cardiovascular diseases"[MeSH Terms]', retmax=.)
```

GDS is a curated version of GSE, yet becoming deprecated (Sean Davis (NIH)'s answer on Biostar). So we'll stick to GSE.

```{r}
if(!file.exists('GEOmetadb.sqlite')) getSQLiteFile()
con <- dbConnect(SQLite(), 'GEOmetadb.sqlite')

cardio_gsm <- dbGetQuery(con, paste('SELECT gsm.gsm, gsm.source_name_ch1, gsm.organism_ch1, organism_ch2, gpl.gpl, gpl.title as platform, technology, gse.submission_date, gse.pubmed_id, gse.title, gse.summary',
                      'FROM gse ',
                      'JOIN gse_gsm ON gse.gse = gse_gsm.gse',
                      'JOIN gse_gpl ON gse.gse = gse_gpl.gse',
                      'JOIN gsm ON gse_gsm.gsm = gsm.gsm',
                      'JOIN gpl ON gse_gpl.gpl = gpl.gpl',
                      'WHERE pubmed_id IN (', paste(cardioPubmed$ids,collapse=','), ')'))
```

Platforms over the years

```{r}
cardio_gsm %>%
    `$<-`('year', as.numeric(gsub('^(\\d{4})(.+)$','\\1', .$submission_date))) %>%
    subset(TRUE,c('year', 'technology', 'gsm')) %>%
    ggplot() +
        geom_line(aes(x=year,group=technology,color=technology), stat='count',alpha=0.5)
```

GEO Data from human samples over the year

```{r}
cardio_gsm %>%
    `$<-`('year', as.numeric(gsub('^(\\d{4})(.+)$','\\1', .$submission_date))) %>%
    subset(grepl('Homo sapiens', .$organism_ch1),c('year', 'organism_ch1', 'gsm')) %>%
    ggplot() +
        geom_line(aes(x=year,group=organism_ch1,color=organism_ch1), stat='count',alpha=0.5)
```

```{r}

cardiovascular_gse <- dbGetQuery(con,paste("select gse,pubmed_id,summary,title from gse where",
                                           "summary like '%cardiovascular%'", sep=" "))
cardiovascular_gds <- dbGetQuery(con,paste("select gds,pubmed_id,gse,platform_organism,sample_organism,description,title from gds where",
                                            "description like '%cardiovascular%'", sep=" "))
str(cardiovascular_gds)
```