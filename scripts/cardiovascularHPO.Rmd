---
title: "Exploration of Cardiovascular Abnormality in the Human Phenotype Ontology"
author: "Trang Tran"
date: "8/19/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(ontologyIndex)
library(RSQLite)
library(ggplot2)
library(plotly)
DATADIR = Sys.getenv('DBDIR')

jaccard <- function(a, b) {
    return(length(intersect(a,b))/ length( union(a,b) ))
}

plot.heatmap <- function(X) {
    mm = reshape2::melt(X)
    p = ggplot(mm) +
        geom_tile(aes(x=Var1,y=Var2,fill=value)) +
        scale_fill_gradient2(low='red', mid='white', high='steelblue') +
        theme(axis.text.x = element_text(angle=30,hjust=1), axis.title.x = element_blank(), axis.title.y = element_blank()) +
        coord_fixed() 
    return(p)   
}
```

The Human Phenotype Ontology can be downloaded (here)[https://raw.githubusercontent.com/obophenotype/human-phenotype-ontology/master/hp.obo] or loaded from the package `ontologyIndex`. The format of `phenotype_annotation.tab` is described (here)[https://hpo.jax.org/app/help/annotations].

```{r}
# Human Phenotype Ontology https://raw.githubusercontent.com/obophenotype/human-phenotype-ontology/master/hp.obo
# curl::curl_download('https://raw.githubusercontent.com/obophenotype/human-phenotype-ontology/master/hp.obo',destfile = 'hpo.obo')
# curl::curl_download('http://compbio.charite.de/jenkins/job/hpo.annotations/lastStableBuild/artifact/misc/phenotype_annotation.tab', destfile = 'phenotype_annotation.tab')
hpo = get_ontology('hpo.obo', extract_tags = 'everything')
phenotypeAnnotation = data.table::fread('phenotype_annotation.tab', sep='\t',header = FALSE, quote = "",
                                        col.names = c('DB', 'DB_Object_ID', 'DB_Name', 'Qualifier', 'HPO_ID', 'DB_Reference', 'Evidence_Code', 'Onset_Modifier', 'Frequency', 'Sex', 'Modifier', 'Aspect', 'Date_Created', 'Assigned_By'))
```

The classes of interest are those related to _cardiovascular system_

```{r}
hpo$name[grep(x=hpo$name, pattern='cardiovascular system',ignore.case = TRUE)]
```

Since the most inclusive term is _Abnormality of the cardiovascular system_, we'll use it as the filter for relevant term.

```{r}
filterPredicate = function(x) {
    return('HP:0001626' %in% get_term_property(hpo,property_name='ancestors',term=x)) 
}
```

Now query for the conditions of interests, and filter for those that are descendants to _Abnormality of the cardiovascular system_

```{r,echo=FALSE}
traverse <- function(ontology, rootId, FUN = function(x) {return(x)}) {
    children = get_term_property(ontology, property_name = 'children', rootId)
    if (length(children) == 0) {
        return(FUN(rootId))
    } else {
        for (child in children) {
            return(traverse(ontology, child, FUN))
        }
    }
}
```

```{r}
commonNames = c('coronary artery disease',
                'congestive heart failure',
                'congenital heart defect',
                'hypertension',
                'cardiomyopathy',
                'stroke',
                'myocardial infarction',
                'angina',
                'arrhythmia')

queryResults = list()
for (name in commonNames) {
    q = list()
    q[['searchResults']] =
        c(hpo$id[grep(x=hpo$synonym, pattern=name,ignore.case = TRUE)],
          hpo$id[grep(x=hpo$name, pattern=name,ignore.case = TRUE)]) %>%
        unique() %>%
        minimal_set(hpo, .)
    q[['relevantTermIds']] = Filter(f = filterPredicate, x = q[['searchResults']])
    queryResults[[name]] = q
}
```


```{r}
for (name in names(queryResults)) {
    q <- queryResults[[name]]
    q[['phenotypeAnnotation']] <- phenotypeAnnotation[HPO_ID %in% q$relevantTermIds]
    queryResults[[name]] <- q
}
```

## Explore OMIM associations

### Phenotype similarity

```{r}
m = matrix(0, nrow=length(commonNames), ncol = length(commonNames)) %>%
    `colnames<-`(commonNames) %>%
    `rownames<-`(commonNames)

for (i in 1:(length(commonNames)-1)) {
    qi = queryResults[[i]]$phenotypeAnnotation
    phe_i = paste(qi$DB, qi$DB_Object_ID, sep=':')
    for (j in (i+1):length(commonNames)) {
        qj <- queryResults[[j]]$phenotypeAnnotation
        phe_j = paste(qj$DB, qj$DB_Object_ID, sep=':')
        m[i,j] = m[j,i] = jaccard(phe_i, phe_j)
    }
}

plot.heatmap(m) + ggtitle('OMIM phenotype similarity')
```

### Gene association similarity

```{r}
m = matrix(0, nrow=length(commonNames), ncol = length(commonNames)) %>%
    `colnames<-`(commonNames) %>%
    `rownames<-`(commonNames)

con <- dbConnect(SQLite(), paste0(DATADIR, '/OMIMdb.sqlite'))

for (i in 1:(length(commonNames)-1)) {
    qi = queryResults[[i]]$phenotypeAnnotation
    qi = qi[(DB) == 'OMIM',]
    map_i <- dbSendQuery(con, paste('SELECT m.PhenotypeMIMNumber, m.GeneMIMNumber, m.MappingNumber, g.ApprovedSymbol',
                              ' FROM gene_phenotype m',
                              ' JOIN genes g ON g.MIMNumber = m.GeneMIMNumber',
                              ' JOIN mappings on mappings.MappingNumber = m.MappingNumber',
                              ' WHERE m.PhenotypeMIMNumber IN ', paste0('(', paste(qi$DB_Object_ID, collapse = ','), ')')
                              )) %>%
    dbFetch()

    for (j in (i+1):length(commonNames)) {
        qj <- queryResults[[j]]$phenotypeAnnotation
        qj <- qj[(DB) == 'OMIM',]
        map_j <- dbSendQuery(con, paste('SELECT m.PhenotypeMIMNumber, m.GeneMIMNumber, m.MappingNumber, g.ApprovedSymbol',
                              ' FROM gene_phenotype m',
                              ' JOIN genes g ON g.MIMNumber = m.GeneMIMNumber',
                              ' JOIN mappings on mappings.MappingNumber = m.MappingNumber',
                              ' WHERE m.PhenotypeMIMNumber IN ', paste0('(', paste(qj$DB_Object_ID, collapse = ','), ')')
                              )) %>%
            dbFetch()

        m[i,j] = m[j,i] = jaccard(map_i$ApprovedSymbol, map_j$ApprovedSymbol)
    }
}

plot.heatmap(m) + ggtitle('OMIM gene association similarity')
```

```{r}
getAnnotations <- function(queryResults, annot) {
    lapply(queryResults, function(q) { return(q$phenotypeAnnotation[,annot, with=FALSE]) }) %>%
        Reduce(rbind, .) %>%
        return()
}
phenotypes <- getAnnotations(queryResults, c('DB', 'DB_Object_ID'))
phenotypes <- phenotypes[(DB) == 'OMIM',]

```

```{r}
res <- dbSendQuery(con, paste('SELECT m.PhenotypeMIMNumber, m.GeneMIMNumber, m.MappingNumber, g.ApprovedSymbol, g.GeneName, mappings.MappingDescription',
                              ' FROM gene_phenotype m',
                              ' JOIN genes g ON g.MIMNumber = m.GeneMIMNumber',
                              ' JOIN mappings on mappings.MappingNumber = m.MappingNumber',
                              ' WHERE m.PhenotypeMIMNumber IN ', paste0('(', paste(phenotypes$DB_Object_ID, collapse = ','), ')')
                              )) %>%
    dbFetch()


```

```{r}
getAnnotations(queryResults, 'DB') %>%
 table(phenotypes) %>%
    set_names( . , hpo$name[names(.)])   
```
